<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Cấu Trúc Đề Thi</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: center;
            vertical-align: middle;
            border: 1px solid #ddd;
            padding: 10px;
            height: 50px;
            /* Đặt chiều cao cố định */
        }

        thead th {
            background-color: #343a40;
            color: white;
        }

        td[colspan] {
            text-align: left;
        }
    </style>
</head>

<body class="bg-light py-4">
    <div class="container">
        <h3 class="text-center mb-4">Bảng Cấu Trúc Đề Thi</h3>
        <div class="table-responsive">
            <table id="examTable" class="table table-bordered table-striped text-center">
                <thead class="table-dark">
                    <tr>
                        <th colspan="1">Lớp</th>
                        <th colspan="3">Chủ đề</th>
                        <th colspan="3">Nội dung</th>
                        <th colspan="12">Cấp độ tư duy</th>
                        <th colspan="1">Tổng</th>
                        <th colspan="1">Tỉ lệ</th>
                    </tr>
                    <tr>
                        <th colspan="1"></th>
                        <th colspan="3"></th>
                        <th colspan="3"></th>

                        <th colspan="4">Phần I</th>
                        <th colspan="4">Phần II</th>
                        <th colspan="4">Phần III</th>
                        <th colspan="1"></th>
                        <th colspan="1"></th>
                    </tr>
                    <tr>
                        <th colspan="1"></th>
                        <th colspan="3"></th>
                        <th colspan="3"></th>
                        <th colspan="1">Nhận biết</th>
                        <th colspan="1">Thông hiểu</th>
                        <th colspan="1">Vận dụng</th>
                        <th colspan="1">Vận dụng cao</th>
                        <th colspan="1">Nhận biết</th>
                        <th colspan="1">Thông hiểu</th>
                        <th colspan="1">Vận dụng</th>
                        <th colspan="1">Vận dụng cao</th>
                        <th colspan="1">Nhận biết</th>
                        <th colspan="1">Thông hiểu</th>
                        <th colspan="1">Vận dụng</th>
                        <th colspan="1">Vận dụng cao</th>
                        <th colspan="1"></th>
                        <th colspan="1"></th>
                    </tr>
                </thead>
                <tbody>

                    <tr class="table-secondary">
                        <td colspan="7">Tổng</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="col-total">0</td>
                        <td class="total-question">0</td>
                        <td></td>
                    </tr>
                    <!-- Hàng Tỉ lệ -->
                    <tr class="fw-bold table-secondary">
                        <td colspan="7">Tỉ lệ</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td class="column-percentage">0%</td>
                        <td>100%</td> <!-- Tổng toàn bộ là 100% -->
                        <td></td>
                    </tr>
                    <!-- Điểm tối đa -->
                    <tr class="fw-bold table-secondary">
                        <td colspan="7">Điểm tối đa</td>
                        <td colspan="4">3</td>
                        <td colspan="4">4</td>
                        <td colspan="4">3</td>
                        <td>10</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.querySelectorAll("#examTable tr").forEach((row, index) => {
            console.log(`Row ${index + 1}: Số cột = ${row.cells.length}`);
        });
        // Dữ liệu mẫu
        const data = [
            {
                lop: 11,
                chuDe: "Lượng giác",
                noiDung: [
                    "Công thức lượng giác cơ bản",
                    "Giải phương trình lượng giác",
                    "Ứng dụng thực tế"
                ]
            },
            {
                lop: 12,
                chuDe: "Hàm số",
                noiDung: [
                    "Đạo hàm và ứng dụng",
                    "Khảo sát hàm số",
                    "Tìm cực trị"
                ]
            }
        ];

        // Hàm tạo hàng mới
        function createRow(lop, chuDe, noiDung) {
    // Hàng đầu tiên với "Lớp" và "Chủ đề"
    const firstRow = `
        <tr>
            <td rowspan="${noiDung.length}">${lop}</td> <!-- Cột "Lớp" -->
            <td rowspan="${noiDung.length}" colspan="3">${chuDe}</td> <!-- Cột "Chủ đề" -->
            <td colspan="3">${noiDung[0]}</td> <!-- Nội dung đầu tiên -->
            ${Array(12).fill('<td><input type="number" class="form-control" min="0" value="0"></td>').join('')}
            <td class="total">0</td>
            <td class="percentage">0%</td>
        </tr>
    `;

    // Các hàng con (bổ sung cột trống cho "Lớp" và "Chủ đề")
    const otherRows = noiDung.slice(1).map(nd => `
        <tr>
            <td colspan="3">${nd}</td> <!-- Các nội dung khác -->
            ${Array(12).fill('<td><input type="number" class="form-control" min="0" value="0"></td>').join('')}
            <td class="total">0</td>
            <td class="percentage">0%</td>
        </tr>
    `).join("");

    return firstRow + otherRows;
}


        // Thêm các hàng vào bảng
        function populateTable() {
            const tbody = document.querySelector("#examTable tbody");
            const totalRow = document.querySelector(".table-secondary");

            data.forEach(item => {
                const newRow = document.createElement("tbody");
                newRow.innerHTML = createRow(item.lop, item.chuDe, item.noiDung);
                tbody.insertBefore(newRow, totalRow);
            });

            // Kiểm tra số lượng cột trong mỗi hàng sau khi thêm
            document.querySelectorAll("#examTable tr").forEach((row, index) => {
                console.log(`Row ${index + 1}:`, row.cells.length);
            });
        }
        populateTable()

        const maxTotalQuestions = 34; // Tổng số câu hỏi toàn bài tối đa

        // Hàm tính tổng toàn bảng
        function calculateTotalQuestions() {
            const columnTotals = document.querySelectorAll('.col-total');
            let totalQuestion = 0;

            columnTotals.forEach((colTotalCell) => {
                totalQuestion += parseInt(colTotalCell.textContent) || 0;
            });

            return totalQuestion;
        }

        // Hàm tính tổng hàng
        function calculateRowTotals() {
            const rows = document.querySelectorAll('tbody tr:not(.table-secondary)');
            const totalQuestionCell = document.querySelector('.total-question');
            const currentTotalQuestions = parseInt(totalQuestionCell.textContent) || 0;

            rows.forEach((row) => {
                const inputs = row.querySelectorAll('input[type="number"]');
                const rowTotalCell = row.querySelector('.total');
                const rowPercentageCell = row.querySelector('.percentage');
                let rowTotal = 0;

                inputs.forEach((input) => {
                    rowTotal += parseInt(input.value) || 0;
                });

                // Cập nhật ô tổng hàng
                rowTotalCell.textContent = rowTotal;

                // Tính phần trăm dựa trên tổng toàn bảng
                const percentage = currentTotalQuestions > 0
                    ? ((rowTotal / currentTotalQuestions) * 100).toFixed(2)
                    : 0;
                rowPercentageCell.textContent = `${percentage}%`;
            });
        }

        // Hàm tính tổng cột và cập nhật hàng "Tỉ lệ"
        function calculateColumnTotals() {
            const columnTotals = document.querySelectorAll('.col-total');
            const rows = document.querySelectorAll('tbody tr:not(.table-secondary)');
            const totalQuestionCell = document.querySelector('.total-question');
            const columnPercentages = document.querySelectorAll('.column-percentage'); // Ô trong hàng Tỉ lệ
            let totalQuestion = 0;

            columnTotals.forEach((colTotalCell, colIndex) => {
                let colTotal = 0;

                rows.forEach((row) => {
                    const input = row.querySelectorAll('input[type="number"]')[colIndex];
                    if (input) {
                        colTotal += parseInt(input.value) || 0;
                    }
                });

                colTotalCell.textContent = colTotal;
                totalQuestion += colTotal;
            });

            // Cập nhật tổng toàn bảng
            totalQuestionCell.textContent = totalQuestion;

            // Tính tỷ lệ ở hàng "Tỉ lệ"
            columnTotals.forEach((colTotalCell, colIndex) => {
                const colTotal = parseInt(colTotalCell.textContent) || 0;
                const currentTotalQuestions = parseInt(totalQuestionCell.textContent) || 0;
                const percentage = currentTotalQuestions > 0
                    ? ((colTotal / currentTotalQuestions) * 100).toFixed(2)
                    : 0;

                if (columnPercentages[colIndex]) {
                    columnPercentages[colIndex].textContent = `${percentage}%`;
                }
            });

            // Cập nhật tỷ lệ hàng
            calculateRowTotals();

            // Kiểm tra giới hạn tối đa
            handleInputLimits(totalQuestion);
        }

        // Hàm xử lý giới hạn tăng giá trị input
        function handleInputLimits(totalQuestion) {
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach((input) => {
                const currentValue = parseInt(input.value) || 0;

                if (totalQuestion >= maxTotalQuestions && currentValue >= input.value) {
                    input.setAttribute('max', currentValue); // Ngăn tăng giá trị
                } else {
                    input.removeAttribute('max'); // Cho phép tăng nếu chưa đạt giới hạn
                }
            });
        }

        // Gắn sự kiện input vào tất cả các ô nhập
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach((input) => {
            input.addEventListener('input', () => {
                calculateColumnTotals();
            });
        });

        // Gọi tính toán ban đầu
        calculateColumnTotals();
        function syncTableCellSizes() {
            const headerCells = document.querySelectorAll("thead th");
            const rows = document.querySelectorAll("#examTable tbody tr");

            // Lấy chiều rộng và chiều cao từ các ô tiêu đề
            headerCells.forEach((th, index) => {
                const width = th.offsetWidth;
                const height = th.offsetHeight;

                // Áp dụng chiều rộng và chiều cao cho tất cả các ô trong cột tương ứng
                rows.forEach(row => {
                    const cell = row.cells[index]; // Lấy ô tương ứng trong hàng
                    if (cell) {
                        cell.style.width = `${width}px`;
                        cell.style.height = `${height}px`;
                    }
                });
            });
        }

        // Gọi hàm sau khi bảng được render
        window.onload = syncTableCellSizes;

    </script>

</body>

</html>